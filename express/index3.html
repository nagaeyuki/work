<!doctype html>
<html>

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title>WebSocket Signaling 1to1</title>
</head>
<!-- <script src="aframe-v0.8.2.min.js"></script> -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>

<script src="three.min.js"></script>
<!-- <script src="signaling.js"></script> -->
<script src="OrbitControls.js"></script>
<script src="https://aframe.io/releases/0.6.1/aframe.min.js"></script>
<style type="text/css">
    a-scene {
        height: 480px;
        width: 640px;
    }
</style>

<body>

    WebSocket Signaling 1to1 (vanilla ICE)
    <br />
    <button type="button" onclick="startVideo();">Start Video</button>
    <button type="button" onclick="stopVideo();">Stop Video</button>
    &nbsp;
    <button type="button" onclick="connect();">Connect</button>
    <button type="button" onclick="hangUp();">Hang Up</button>
    <!-- <div>
        <div id="myEmbeddedScene">
            <a-scene embedded vr-mode-ui="enabled: false">
                <a-assets>
                    <video id="local_video" autoplay loop crossorigin="anonymous" style="width: 640px; height: 480px; border: 1px solid black; display: true;"></video>
                </a-assets>
                <a-videosphere src="#local_video" rotation="0 180 0"></a-videosphere>
            </a-scene>
        </div>
        <div> -->
    <div>
        <div id="myEmbeddedScene">
            <a-scene embedded vr-mode-ui="enabled: false">
                <a-assets>
                    <video id="remote_video" autoplay loop crossorigin="anonymous" style="width: 640px; height: 480px; border: 1px solid black; display: true;"></video>
                </a-assets>
                <a-videosphere src="#remote_video" rotation="0 180 0"></a-videosphere>
            </a-scene>
        </div>
        <div>
            <!-- <a-scene embedded vr-mode-ui="enabled: false">
                <video id="local_video2" autoplay loop crossorigin="anonymous"></video>
                <a-videosphere src="#local_video2" rotation="0 180 0"></a-videosphere>
            </a-scene>
        </div> -->
            <!-- <video id="local_video" autoplay style="width: 400px; height: 200px; border: 1px solid black;"></video> -->


            <!-- <a-scene>
                <a-assets> -->
            <br>
            <br>
            <br>
            <br>
            <!-- <video id="local_video" autoplay style="width: 400px; height: 200px; border: 1px solid black;"></video> -->
            <br>
            <br>
            <br>
            <br>
            <!-- <video id="local_video" autoplay style="width: 400px; height: 200px; border: 1px solid black;"></video> -->
            <br>
            <br>
            <br>
            <br>
            <!-- <video id="local_video" autoplay style="width: 400px; height: 200px; border: 1px solid black;"></video> -->
            <br>
            <br>
            <br>
            <br>
            <!-- <video id="local_video" autoplay style="width: 400px; height: 200px; border: 1px solid black;"></video> -->
            <br>
            <br>
            <br>
            <br>
            <br>

            <div class="relative">
                <video id="local_video" autoplay width="960" height="480" style=" display: true;"></video>
                <p id="top" alt="" class="absolute" />
                <p id="bottom" alt="" class="absolute" />
                <p id="left" alt="" class="absolute" />
                <p id="right" alt="" class="absolute" />

            </div>
            <br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
            <p>canvas</p>
            <canvas style="display:true;"></canvas>

            <p>canvas2</p>
            <canvas style="display:true;" id="face" width="1920"" height=" 960"></canvas>
            <!-- </a-assets>
            </a-scene> -->



        </div>

        <p>SDP to send:
            <br />
            <textarea id="text_for_send_sdp" rows="5" cols="60" readonly="readonly">SDP to send</textarea>
        </p>
        <p>SDP received:&nbsp;

            <button type="button" onclick="onSdpText();">Receive remote SDP</button>

            <br />
            <textarea id="text_for_receive_sdp" rows="5" cols="60"></textarea>
        </p>


</body>
<style>

    .relative {
position: relative;
}
.absolute {
position: absolute;
background: #ffffff;
}
/* #top{
    background:red;
}
#bottom{
background:green;
}
#left{
background:blue;
}
#right{
background:yellow;
} */
    #hide {
        width: 1440px;
        height: 720px;
        background: #ccc;
        
    }
</style>
<script type="text/javascript">
    //もともとはこの一文あったけど必要なのか？
    //window.addEventListener('DOMContentLoaded', theta_view('local_video'), false);
    let localVideo = document.getElementById('local_video');
    let localVideo2 = document.getElementById('local_video2');
    let remoteVideo = document.getElementById('remote_video');
    let localStream = null;
    let peerConnection = null;
    let textForSendSdp = document.getElementById('text_for_send_sdp');
    let textToReceiveSdp = document.getElementById('text_for_receive_sdp');
    // --- prefix -----
    navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia ||
        navigator.mozGetUserMedia || navigator.msGetUserMedia;
    RTCPeerConnection = window.RTCPeerConnection || window.webkitRTCPeerConnection || window.mozRTCPeerConnection;
    RTCSessionDescription = window.RTCSessionDescription || window.webkitRTCSessionDescription || window.mozRTCSessionDescription;
    // -------- websocket ----
    // please use node.js app
    //  
    // or you can use chrome app (only work with Chrome)
    //  https://chrome.google.com/webstore/detail/simple-message-server/bihajhgkmpfnmbmdnobjcdhagncbkmmp
    //
    var host = window.document.location.host.replace(/:.*/, '');
    var ws = new WebSocket('ws://' + host + ':3000');
    ws.onopen = function (evt) {
        console.log('ws open()');
    };
    ws.onerror = function (err) {
        console.error('ws onerror() ERR:', err);
    };
    ws.onmessage = function (evt) {
        console.log('ws onmessage() data:', evt.data);
        let message = JSON.parse(evt.data);
        if (message.type === 'offer') {
            // -- got offer ---
            console.log('Received offer ...');
            textToReceiveSdp.value = message.sdp;
            let offer = new RTCSessionDescription(message);
            setOffer(offer);
        } else if (message.type === 'answer') {
            // --- got answer ---
            console.log('Received answer ...');
            textToReceiveSdp.value = message.sdp;
            let answer = new RTCSessionDescription(message);
            setAnswer(answer);
        }
    };

    var canvas = document.querySelector('canvas');
    var ctx = canvas.getContext('2d');
    var canvasWidth = 0;
    var canvasHeight = 0;
    let face = document.getElementById('face');
    var ctxface = face.getContext('2d');
    // ---------------------- media handling ----------------------- 
    // start local video
    function startVideo() {
        getDeviceStream({
                video: true,
                audio: true
            })
            .then(function (stream) { // success
                localStream = stream;
                playVideo(localVideo, stream);
                //playVideo(localVideo2, stream);
            }).catch(function (error) { // error
                console.error('getUserMedia error:', error);
                return;
            });
    }


    var base64 = '';
    var x = [];
    // カメラ画像キャプチャ
    var capture = function () {
        //canvasのサイズを指定
        const scale = 0.5;
        canvasWidth = localVideo.videoWidth * scale;
        canvasHeight = localVideo.videoHeight * scale;
        //const ratio = localVideo.videoHeight;
        // localVideo.videoWidth;
        //canvasWidth = localVideo.videoHeight;
        //canvasHeight=localVideo.videoHeight * ratio;
        canvas.width = canvasWidth;
        canvas.height = canvasHeight;

        // console.log(localVideo.videoHeight)
        if (localStream) {
            ctx.drawImage(localVideo, 0, 0, canvasWidth, canvasHeight);
    
            base64 = canvas.toDataURL('image/webp');
ctx.beginPath();
ctx.rect(x[0], x[1], x[2], x[3]);
ctx.stroke();

        }

// var img3 = new Image();
// img3.src = "dst.png";
// // ctxface.clearRect(0, 0, 960, 480);
// // ctxface.drawImage(localVideo, 200, 200, 500, 500, 0, 0, 400, 400);
// img3.onload = function () {
// var width = img3.width;
// var height = img3.height;
// var scale = 0.5;
// ctxface.drawImage(img3, x[0]/0.8, x[1]/0.8, x[2]*3, x[3]*3, 0, 0, 480, 240);
// // ctxface.drawImage(img3, 200, 200, 500, 500, 0, 0, 400, 400);

// }


    }
    //認識
    var detect = function () {
        var request = {
            url: "http://localhost:3000",
            type: 'POST',
            data: {
                image: base64.replace(/^.*,/, '')
                // image: "画像データ" 
            }
        };
        // console.log(request);
        $.ajax(request).done(function (data) {
            if (data.face) {
                if ((data.face.split(' ').length) == 4) {
                    for (var i = 0; i < data.face.split(' ').length; i++) {
                        x[i] = data.face.split(' ')[i] - 0;
                    }

                    // var hide = document.getElementById('hide');
                    var top = document.getElementById('top');
                    var right = document.getElementById('right');
                    var left = document.getElementById('left');
                    var bottom = document.getElementById('bottom');
                    top.style.height = x[1] - 50 + "px";
                    top.style.width = "960px"
                    top.style.top = "-30px";
                    top.style.left = "0px";
                    bottom.style.height = 480 - x[1] - x[3] - 50 + "px";
                    bottom.style.top = x[1] + x[3] + 50 + "px"
                    bottom.style.width = "960px"
                    bottom.style.left = "0px"
                    left.style.height = "480px";
                    left.style.left = "0px";
                    left.style.top = "0px";
                    left.style.width = x[0] - 50 + "px";
                    right.style.width = 960 - x[0] - x[2] - 50 + "px";
                    right.style.left = x[0] + x[2] + 50 + "px";
                    right.style.height = "480px";
                    right.style.top = "0px";
                    // hide.style.marginleft = x[0];
                    // hide.style.marginTop = x[1];

                    //y-50:y+h+100, x-50:x+w+100
// ctxface.drawImage(localVideo, x[0]-150, x[1]-150, x[2]+350, x[3]+350, 0, 0, x[2]+150, x[3]+150);

                    // ctxface.drawImage(localVideo, 100, 100, 100, 100, 0, 0, 100, 100);
                    // var scale = 0.5;

                    // ctxface.drawImage(localVideo,0, 0, 640,480, 0, 0, canvasWidth, canvasHeight);
                    // localVideo.width = x[0];
                    // localVideo.height = x[1];
var img3 = new Image();
img3.src = "outfile2.png";
// ctxface.drawImage(localVideo, 200, 200, 500, 500, 0, 0, 400, 400);
img3.onload = function () {
var width = img3.width;
var height = img3.height;
var scale = 0.5;
// ctxface.drawImage(img3, x[0]-150, x[1]-150, x[2]+350, x[3]+350, 0, 0, x[2]*20, x[3]*20);
// ctxface.drawImage(img3, 200, 200, 500, 500, 0, 0, 400, 400);

}

                    // console.log("true:  " + data.face);
                    console.log(data.face.split(' '));
                }
            } else {
                // console.log(data.face.length);
                // x[0] = x[1] = x[2] = x[3] = "";
            }
        });
    }
    setInterval("capture()", 100);
    setInterval("detect()", 1000);

    // stop local video
    function stopVideo() {
        pauseVideo(localVideo);
        stopLocalStream(localStream);
    }

    function stopLocalStream(stream) {
        let tracks = stream.getTracks();
        if (!tracks) {
            console.warn('NO tracks');
            return;
        }
        for (let track of tracks) {
            track.stop();
        }
    }

    function getDeviceStream(option) {
        console.log(navigator.mediaDevices);
        if ('getUserMedia' in navigator.mediaDevices) {
            console.log('navigator.mediaDevices.getUserMadia');
            return navigator.mediaDevices.getUserMedia(option);
        } else {
            console.log('wrap navigator.getUserMadia with Promise');
            return new Promise(function (resolve, reject) {
                navigator.getUserMedia(option,
                    resolve,
                    reject
                );
            });
        }
    }

    function playVideo(element, stream) {
        if ('srcObject' in element) {
            element.srcObject = stream;
            console.log("true");
        } else {
            console.log("test");
            element.src = window.URL.createObjectURL(stream);
        }
        element.play();
        element.volume = 0;
    }

    function pauseVideo(element) {
        element.pause();
        if ('srcObject' in element) {
            element.srcObject = null;
        } else {
            if (element.src && (element.src !== '')) {
                window.URL.revokeObjectURL(element.src);
            }
            element.src = '';
        }
    }
    // ----- hand signaling ----
    function onSdpText() {
        let text = textToReceiveSdp.value;
        if (peerConnection) {
            console.log('Received answer text...');
            let answer = new RTCSessionDescription({
                type: 'answer',
                sdp: text,
            });
            setAnswer(answer);
        } else {
            console.log('Received offer text...');
            let offer = new RTCSessionDescription({
                type: 'offer',
                sdp: text,
            });
            setOffer(offer);
        }
        textToReceiveSdp.value = '';
    }

    function sendSdp(sessionDescription) {
        console.log('---sending sdp ---');
        textForSendSdp.value = sessionDescription.sdp;
        /*---
        textForSendSdp.focus();
        textForSendSdp.select();
        ----*/
        let message = JSON.stringify(sessionDescription);
        console.log('sending SDP=' + message);
        ws.send(message);
    }
    // ---------------------- connection handling -----------------------
    function prepareNewConnection() {
        let pc_config = {
            "iceServers": []
        };
        let peer = new RTCPeerConnection(pc_config);
        // --- on get remote stream ---
        if ('ontrack' in peer) {
            peer.ontrack = function (event) {
                console.log('-- peer.ontrack()');
                let stream = event.streams[0];
                playVideo(remoteVideo, stream);
            };
        } else {
            peer.onaddstream = function (event) {
                console.log('-- peer.onaddstream()');
                let stream = event.stream;
                playVideo(remoteVideo, stream);
            };
        }
        // --- on get local ICE candidate
        peer.onicecandidate = function (evt) {
            if (evt.candidate) {
                console.log(evt.candidate);
                // Trickle ICE の場合は、ICE candidateを相手に送る
                // Vanilla ICE の場合には、何もしない
            } else {
                console.log('empty ice event');
                // Trickle ICE の場合は、何もしない
                // Vanilla ICE の場合には、ICE candidateを含んだSDPを相手に送る
                sendSdp(peer.localDescription);
            }
        };
        // --- when need to exchange SDP ---
        peer.onnegotiationneeded = function (evt) {
            console.log('-- onnegotiationneeded() ---');
        };
        // --- other events ----
        peer.onicecandidateerror = function (evt) {
            console.error('ICE candidate ERROR:', evt);
        };
        peer.onsignalingstatechange = function () {
            console.log('== signaling status=' + peer.signalingState);
        };
        peer.oniceconnectionstatechange = function () {
            console.log('== ice connection status=' + peer.iceConnectionState);
            if (peer.iceConnectionState === 'disconnected') {
                console.log('-- disconnected --');
                hangUp();
            }
        };
        peer.onicegatheringstatechange = function () {
            console.log('==***== ice gathering state=' + peer.iceGatheringState);
        };
        peer.onconnectionstatechange = function () {
            console.log('==***== connection state=' + peer.connectionState);
        };
        peer.onremovestream = function (event) {
            console.log('-- peer.onremovestream()');
            pauseVideo(remoteVideo);
        };
        // -- add local stream --
        if (localStream) {
            console.log('Adding local stream...');
            peer.addStream(localStream);
        } else {
            console.warn('no local stream, but continue.');
        }
        return peer;
    }

    function makeOffer() {
        peerConnection = prepareNewConnection();
        peerConnection.createOffer()
            .then(function (sessionDescription) {
                console.log('createOffer() succsess in promise');
                return peerConnection.setLocalDescription(sessionDescription);
            }).then(function () {
                console.log('setLocalDescription() succsess in promise');
                // -- Trickle ICE の場合は、初期SDPを相手に送る -- 
                // -- Vanilla ICE の場合には、まだSDPは送らない --
                //sendSdp(peerConnection.localDescription);
            }).catch(function (err) {
                console.error(err);
            });
    }

    function setOffer(sessionDescription) {
        if (peerConnection) {
            console.error('peerConnection alreay exist!');
        }
        peerConnection = prepareNewConnection();
        peerConnection.setRemoteDescription(sessionDescription)
            .then(function () {
                console.log('setRemoteDescription(offer) succsess in promise');
                makeAnswer();
            }).catch(function (err) {
                console.error('setRemoteDescription(offer) ERROR: ', err);
            });
    }

    function makeAnswer() {
        console.log('sending Answer. Creating remote session description...');
        if (!peerConnection) {
            console.error('peerConnection NOT exist!');
            return;
        }
        peerConnection.createAnswer()
            .then(function (sessionDescription) {
                console.log('createAnswer() succsess in promise');
                return peerConnection.setLocalDescription(sessionDescription);
            }).then(function () {
                console.log('setLocalDescription() succsess in promise');
                // -- Trickle ICE の場合は、初期SDPを相手に送る -- 
                // -- Vanilla ICE の場合には、まだSDPは送らない --
                //sendSdp(peerConnection.localDescription);
            }).catch(function (err) {
                console.error(err);
            });
    }

    function setAnswer(sessionDescription) {
        if (!peerConnection) {
            console.error('peerConnection NOT exist!');
            return;
        }
        peerConnection.setRemoteDescription(sessionDescription)
            .then(function () {
                console.log('setRemoteDescription(answer) succsess in promise');
            }).catch(function (err) {
                console.error('setRemoteDescription(answer) ERROR: ', err);
            });
    }
    // start PeerConnection
    function connect() {

        if (!peerConnection) {
            console.log('make Offer');
            makeOffer();
        } else {
            console.warn('peer already exist.');
        }


    }
    // close PeerConnection
    function hangUp() {
        if (peerConnection) {
            console.log('Hang up.');
            peerConnection.close();
            peerConnection = null;
            pauseVideo(remoteVideo);
        } else {
            console.warn('peer NOT exist.');
        }
    }
</script>

</html>